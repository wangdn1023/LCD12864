#include "public.h"
#include "systick.h"
#include "LCD12864.h"
#include "adc.h"
#include "DCMotor.h"
#include "exti.h"
#include "stm32f10x_it.h"
#include "iic.h"
#include "AT24CXX.h"
#include "nrf24l01.h"
#include "spi.h"
#include "pwm.h"
#include "time.h"
/*旧LOGO
	uint8_t Image[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xC0,0x00,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x03,0xFF,0xE0,0x00,0x00,0x03,0xFF,0xF0,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x07,0xFF,0x00,0x00,0x00,0x00,0x1F,0xFC,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x1F,0xF8,0x00,0x00,0x00,0x00,0x07,0xFE,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x3F,0xC0,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xC0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xE0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xE0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,
	0x00,0x00,0x00,0x0F,0x87,0xFF,0xF0,0xF8,0x07,0xEF,0xFF,0xE0,0x7C,0x00,0x00,0x00,
	0x00,0x00,0x00,0x0F,0x07,0xFF,0xF8,0xF8,0x07,0xEF,0xFF,0xF0,0x3C,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x07,0xFF,0xFC,0xF8,0x07,0xEF,0xFF,0xF0,0x1E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x07,0xFF,0xFC,0xF8,0x07,0xEF,0xFF,0xF8,0x0E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x3C,0x07,0xFF,0xFC,0xFC,0x07,0xEF,0xFF,0xF8,0x0E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x3C,0x07,0xC0,0x7C,0xFC,0x07,0xEF,0xC1,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xC0,0x7C,0xFC,0x0F,0xEF,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xC0,0x7C,0xFD,0xFF,0xEF,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xFF,0xFC,0xFD,0xFF,0xEF,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xFF,0xFC,0xFD,0xFF,0xEF,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xFF,0xFC,0x7D,0xFF,0xCF,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xC0,0x7C,0x01,0xF8,0x0F,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x38,0x07,0xC0,0x7C,0x01,0xF8,0x0F,0xC0,0xF8,0x07,0x00,0x00,0x00,
	0x00,0x00,0x00,0x3C,0x07,0xC0,0x7C,0x01,0xF8,0x0F,0xC0,0xF8,0x0F,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1C,0x07,0xDF,0xFC,0x01,0xF8,0x0F,0xDF,0xF8,0x0F,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x07,0xDF,0xFC,0x01,0xF8,0x0F,0xDF,0xF8,0x1E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x1E,0x07,0xDF,0xFC,0x01,0xF8,0x0F,0xDF,0xF8,0x1E,0x00,0x00,0x00,
	0x00,0x00,0x00,0x0F,0x07,0xDF,0xF8,0x01,0xF8,0x0F,0xDF,0xF8,0x3C,0x00,0x00,0x00,
	0x00,0x00,0x00,0x07,0x87,0xDF,0xF0,0x01,0xF8,0x0F,0xDF,0xF8,0x7C,0x00,0x00,0x00,
	0x00,0x00,0x00,0x07,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,
	0x00,0x00,0x00,0x03,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0xE0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xC0,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x7F,0x80,0x00,0x00,0x00,0x00,0x00,0x3F,0x80,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x3F,0xE0,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x1F,0xF8,0x00,0x00,0x00,0x00,0x07,0xFE,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x07,0xFF,0x00,0x00,0x00,0x00,0x3F,0xF8,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x01,0xFF,0xF8,0x00,0x00,0x03,0xFF,0xF0,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,0xF0,0x03,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x3C,0xF9,0xF1,0x0F,0x8F,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x42,0x0A,0x11,0x08,0x50,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x42,0x7A,0x11,0x08,0x50,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x42,0x8A,0x11,0x08,0x4F,0x84,0x21,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x20,0x42,0x8A,0x11,0x08,0x40,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x3F,0x3C,0xF9,0xF1,0x08,0x40,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x80,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x80,0x00,0x00,0x00,0x00};
*/
		uint8_t Image[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x3F,0xFF,0xFF,0xFF,0xF0,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFE,0x00,
0x3F,0xFF,0xFF,0xFF,0xF8,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFF,0x80,
0x3F,0xFF,0xFF,0xFF,0xFC,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFF,0xC0,
0x3F,0xFF,0xFF,0xFF,0xFE,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFF,0xE0,
0x3F,0xFF,0xFF,0xFF,0xFF,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFF,0xF0,
0x3F,0xFF,0xFF,0xFF,0xFF,0x0F,0x80,0x00,0x00,0x00,0xF8,0x7F,0xFF,0xFF,0xFF,0xF8,
0x00,0x00,0x00,0x00,0x3F,0x0F,0x80,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x03,0xFC,
0x00,0x00,0x00,0x00,0x1F,0x0F,0x80,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0xFC,
0x00,0x00,0x00,0x00,0x1F,0x0F,0x80,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x7E,
0x00,0x00,0x00,0x00,0x3F,0x0F,0xC0,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x7E,
0x3F,0xFF,0xFF,0xFF,0xFF,0x0F,0xE0,0x00,0x00,0x03,0xF8,0x00,0x00,0x00,0x00,0x3E,
0x3F,0xFF,0xFF,0xFF,0xFF,0x0F,0xFF,0xFC,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x3E,
0x3F,0xFF,0xFF,0xFF,0xFE,0x0F,0xFF,0xFC,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x3E,
0x3F,0xFF,0xFF,0xFF,0xFC,0x0F,0xFF,0xFC,0xFF,0xFF,0xF8,0x00,0x00,0x00,0x00,0x3E,
0x3F,0xFF,0xFF,0xFF,0xFE,0x07,0xFF,0xFC,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x3E,
0x3F,0xFF,0xFF,0xFF,0xFF,0x03,0xFF,0xFC,0xFF,0xFF,0xE0,0x00,0x00,0x00,0x00,0x3E,
0x00,0x00,0x00,0x00,0x3F,0x01,0xFF,0xFC,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x7E,
0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,
0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,
0x00,0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x03,0xFC,
0x3F,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xF8,
0x3F,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xF8,
0x3F,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xF0,
0x3F,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xE0,
0x3F,0xFF,0xFF,0xFF,0xF8,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0x80,
0x3F,0xFF,0xFF,0xFF,0xE0,0x00,0x00,0x00,0xF8,0x00,0x00,0x7F,0xFF,0xFF,0xFE,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
	
	int l_auto,r_auto,save;
	int time1s;
//	extern u8 tx_buf[9];	
	u8 rx_buf[9]={0,0,0,0,0,0,0,0};	
	u8 tx_buf[9]={0,0,0,0,0,0,0,0};	
	u8 tx_data[9]={0,0,0,0,0,0,0,0};	
	u8 rx_data[9]={0,0,0,0,0,0,0,0};	
	u16 Arr[181]={
		3978,3970,3962,3953,3944,3934,3924,3914,3902,3890,
		3878,3865,3851,3836,3821,3805,3789,3772,3753,3735,
		3715,3694,3673,3651,3628,3604,3579,3553,3527,3499,
		3471,3441,3411,3380,3348,3315,3281,3246,3211,3175,
		3137,3099,3061,3021,2981,2940,2899,2857,2814,2771,
		2727,2683,2639,2594,2549,2504,2458,2413,2367,2321,
		2275,2229,2183,2138,2093,2048,2003,1958,1914,1870,
		1827,1784,1741,1699,1658,1617,1577,1537,1498,1460,
		1422,1385,1349,1313,1278,1244,1210,1178,1146,1114,
		1084,1054,1024,996,968,941,915,889,864,839,
		816,793,770,748,727,706,686,666,647,629,
		611,593,577,560,544,529,514,499,485,472,
		458,446,433,421,409,398,386,376,365,355,
		346,336,327,318,309,301,293,285,277,270,
		262,256,249,242,236,230,224,218,212,207,
		201,196,191,186,182,177,172,168,164,160,
		156,152,148,145,141,138,134,131,128,125,
		122,119,116,114,111,108,106,103,101,99,
		97};

	u16 ArrDuct[141]={
		3892,3880,3868,3856,3844,3832,3820,3808,3792,3776,
		3764,3748,3728,3712,3696,3676,3656,3636,3616,3596,
		3576,3552,3528,3508,3484,3456,3432,3404,3380,3352,
		3324,3292,3264,3232,3204,3172,3140,3108,3072,3040,
		3004,2972,2936,2900,2864,2828,2792,2752,2716,2676,
		2640,2600,2564,2524,2484,2448,2408,2368,2328,2288,
		2252,2212,2172,2132,2096,2056,2016,1980,1940,1904,
		1868,1828,1792,1756,1720,1684,1652,1616,1580,1548,
		1516,1480,1448,1416,1388,1356,1324,1296,1264,1236,
		1208,1180,1152,1128,1100,1076,1052,1024,1000,976,
		956,928,908,888,868,848,828,808,788,768,
		748,732,716,696,680,664,648,632,616,604,
		588,576,560,548,536,520,508,496,484,472,
		464,452,440,432,420,412,400,392,384,372,
		364
	};		
		
	u16 ArrPower[11]={2792,3266,3331,3369,3396,3424,3471,3572,3601,3694,3908};
		
	u8 save_buf_lo[9]={0,0,0,0,0,0,0,0};		
	u8 save_buf_hi[9]={0,0,0,0,0,0,0,0};		
	
void swap(u16 *data1,u16 *data2);
void IntDisplay(u16 data,u8 row,u8 column);
void IntDisplay2(u16 data,u8 row,u8 column);	
void IntDisplay3(u16 data,u8 row,u8 column);
void IntDisplay4(int data,u8 row,u8 column);	
void DisplayStructure();
void MenuDisplayStructure();
void Menu();
void ADC_Service();
void ADC_Service_Duct();
void NRF_Service(u16 step,u8 direction);
void StepMotorCW(u16 step);
void StepMotorCCW(u16 step);	
void ServoMotor(u16 inputAD);
u8 LinearSearch(u16 *Array,u16 index,u8 length);	

int main()
{

	u8 i=0;
	u8 j=0,k=0;	
	u8 flag=0;		
	u16 power=0,powerAD,motorAD;
	u16 buffer[30]={0};	
	u16 index=1,index2=1;
	u16 adc0,adc1,adc2,adc3;
	u32 ti=0;
	
	u16 min=0,max=10;	
	u16 temp;
	short int InputStep=0;
	short int InputAD=0;	
	u16 LastStep=0;
	short int pwm=0;

//	key_init();
	exti_init();  //外部中断初始化
	adc_init();	
	DC_Motor_init();
	Lcd_Init();
	lcd_GPIO_init();
	NRF24L01_Init();

	time_init();  //定时器3初始化	

	GPIO_SetBits(GPIOC,SolValve);	//电磁阀断开初始化
	LCD_Clear();
	I2C_INIT();		 //IIC初始化
	delay_ms(100);	
	
	LCD_Clear();
	LCD_Display_Picture(Image);	
	delay_ms(1000);
		delay_ms(1000);	
			delay_ms(1000);	
			
	LCD_Clear();
	LCD_Display_Words(1,0,"欢迎使用调试助手");
	LCD_Display_Words(3,1," Power by XLab");	
	delay_ms(1000);		
		delay_ms(1000);	
			delay_ms(1000);	
	LCD_Clear();
		
	MenuDisplayStructure();		
	
	time1s=0;
	
//菜单选择	
while(1)
{
		ADC_RegularChannelConfig(ADC1,ADC_Channel_2,1,ADC_SampleTime_239Cycles5);	//ADC2
		powerAD=ReadADC();
		IntDisplay(index,3,4);
	
		buffer[k]=LinearSearch(ArrPower,powerAD,11);
	k++;
	if(k==30)
		k=0;
	power=0;
	for(i=0;i<30;i++)
	{
		power=power+buffer[i];
	}
	if(time1s==1)
	{
		IntDisplay(power/30,3,6);	
		time1s=0;
	}

	if(tx_buf[0]&0x01)		//功能序号加1
	{
		index++;
		if(index > 6)
			index=1;
		InputStep = 0;
		IntDisplay(index,3,4);
		tx_buf[0]=tx_buf[0]&0xfe;	
	}

	if(tx_buf[0]&0x02)		//功能序号减1
	{
		index--;
		if(index < 1)
			index=6;		
		IntDisplay(index,3,4);
		tx_buf[0]=tx_buf[0]&0xfd;	
	}	

	if(tx_buf[0]&0x08)		//进入子模块
	{
		LCD_Clear();		
		tx_buf[0]=tx_buf[0]&0xf7;	
		switch(index)
		{
			case 1:		
				LCD_Display_Words(0,0,"请输入步数：");	
				LastStep=AT24Cxx_ReadTwoByte(16);	
				InputStep=LastStep;
				IntDisplay(LastStep,1,0);			
				while(!(tx_buf[0]&0x04))
				{
						if((tx_buf[1]&0x02))	
						{
							LCD_Clear();								
							LCD_Display_Words(0,0,"正在复位....");					
							StepMotorCCW(575);
							GPIO_ResetBits(GPIOA,in1|in2|in3|in4);						
							tx_buf[1]=tx_buf[1]&0xfd;		
							AT24Cxx_WriteTwoByte(16,0);	
							InputStep=0;
							LastStep=0;							
							IntDisplay(InputStep,1,0);	
							LCD_Display_Words(0,0,"请输入步数：");								
						}	
						if(tx_buf[0]&0x01)		//步数加1
						{
							InputStep++;
							if(InputStep > 480)
								InputStep = 0;
							IntDisplay(InputStep,1,0);
							delay_ms(40);	
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_8)!=0)		
								tx_buf[0]=tx_buf[0]&0xfe;									
						}

						if((tx_buf[0]&0x02))		//步数减1
						{
							InputStep--;
							if(InputStep <0)
								InputStep = 480;
							IntDisplay(InputStep,1,0);
							delay_ms(40);								
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_9)!=0)									
							tx_buf[0]=tx_buf[0]&0xfd;	
						}	
						
						if(tx_buf[0]&0x08)		//确认进入
						{
							LCD_Display_Words(2,0,"正在运行");								
							if(InputStep>LastStep)
								StepMotorCW(InputStep-LastStep);	
							else
								StepMotorCCW(LastStep-InputStep);
							
							GPIO_ResetBits(GPIOA,in1|in2|in3|in4);	
							LCD_Display_Words(2,0,"执行完毕");							
							tx_buf[0]=tx_buf[0]&0xf7;
							LastStep=InputStep;		
							AT24Cxx_WriteTwoByte(16,InputStep);								
						}						
				}

			break;
			case 2:
				LCD_Display_Words(0,0,"电磁阀");				
				while(!(tx_buf[0]&0x04))
				{
						if(tx_buf[0]&0x01)		//功能序号加1
						{
							LCD_Display_Words(1,0,"吸合");
							GPIO_ResetBits(GPIOC,SolValve);							

							tx_buf[0]=tx_buf[0]&0xfe;									
						}

						if(tx_buf[0]&0x02)	//功能序号减1
						{
							LCD_Display_Words(1,0,"断开");	
							GPIO_SetBits(GPIOC,SolValve);										
							tx_buf[0]=tx_buf[0]&0xfd;	
						}						
				}
				break;		
			case 3:
				LCD_Display_Words(0,0,"请输入目标AD值");
				LCD_Display_Words(1,0,"目标值:");
				LCD_Display_Words(2,0,"当前值:");			
				InputAD=AT24Cxx_ReadTwoByte(18);	
				IntDisplay2(InputAD,1,4);				
				while(!(tx_buf[0]&0x04))
				{						
						if(tx_buf[0]&0x01)		//步数加1
						{
							InputAD++;
							if(InputAD > 970)
								InputAD = 50;
							IntDisplay2(InputAD,1,4);
							delay_ms(25);	
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_8)!=0)		
								tx_buf[0]=tx_buf[0]&0xfe;									
						}

						if((tx_buf[0]&0x02))		//步数减1
						{
							InputAD--;
							if(InputAD <50)
								InputAD = 970;
							IntDisplay2(InputAD,1,4);
							delay_ms(25);	
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_9)!=0)									
							tx_buf[0]=tx_buf[0]&0xfd;	
						}
						
						if(tx_buf[0]&0x08)		//确认进入
						{
							LCD_Display_Words(3,0,"正在运行");								
							ServoMotor(InputAD);	
							LCD_Display_Words(3,0,"执行完毕");							
							tx_buf[0]=tx_buf[0]&0xf7;	
							AT24Cxx_WriteTwoByte(18,InputAD);								
						}		
						if(time1s==1)
						{
							ADC_RegularChannelConfig(ADC1,ADC_Channel_3,1,ADC_SampleTime_239Cycles5);	//ADC2
							temp=ReadADC()/4;						
							IntDisplay2(temp,2,4);	
							time1s=0;
						}
						
				}
				break;		
			case 4:	
				LCD_Display_Words(0,0,"请输入占空比PWM");
				pwm_init();	 //PWM初始化					
				while(!(tx_buf[0]&0x04))
				{
						if(tx_buf[0]&0x01)		//步数加1
						{
							pwm++;
							if(pwm > 100)
								pwm = 0;
							IntDisplay(pwm,1,0);
							delay_ms(50);	
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_8)!=0)		
								tx_buf[0]=tx_buf[0]&0xfe;									
						}

						if((tx_buf[0]&0x02))		//步数减1
						{
							pwm--;
							if(pwm <0)
								pwm = 100;
							IntDisplay(pwm,1,0);
							delay_ms(50);								
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_9)!=0)									
							tx_buf[0]=tx_buf[0]&0xfd;	
						}					
							TIM_SetCompare1(TIM3, pwm*90);																						
				}
			break;		
			case 5:		
					while(!(tx_buf[0]&0x04)){
					LCD_Display_Words(0,0,"1 PT传感器");
					LCD_Display_Words(1,0,"2 通道温度传感器");
					LCD_Display_Words(2,0,"Select:");		
					if(tx_buf[0]&0x01)		//功能序号加1
					{
						index2++;
						if(index2 > 2)
							index2=1;
						IntDisplay(index2,2,4);
						tx_buf[0]=tx_buf[0]&0xfe;	
					}

					if(tx_buf[0]&0x02)		//功能序号减1
					{
						index2--;
						if(index2 < 1)
							index2=2;		
						IntDisplay(index2,2,4);
						tx_buf[0]=tx_buf[0]&0xfd;	
					}		
					
					if(tx_buf[0]&0x08)		//进入二级子模块
					{
						LCD_Clear();		
						tx_buf[0]=tx_buf[0]&0xf7;	
						switch(index2)
						{
							case 1:
							LCD_Display_Words(0,0,"压力");
							LCD_Display_Words(0,3,"AD:");
							LCD_Display_Words(1,0,"PT35:");			
							LCD_Display_Words(1,6,"KPa");			
							LCD_Display_Words(2,0,"PT12:");			
							LCD_Display_Words(2,6,"KPa");		
							LCD_Display_Words(3,0,"温度");						
						
							while(!(tx_buf[0]&0x04))
							{
								if(time1s==1)
								{
									ADC_Service();		
									time1s=0;
								}				
							}	
							break;
							
							case 2:
							LCD_Display_Words(0,0,"通道温度：");
							LCD_Display_Words(2,0,"AD值：");					
						
							while(!(tx_buf[0]&0x04))
							{
								if(time1s==1)
								{
									ADC_Service_Duct();		
									time1s=0;
								}				
							}			
							break;							
					}
					LCD_Clear();	
					tx_buf[0]=tx_buf[0]&0xfb;	
				}
			}
			break;		
			case 6:
			while(!(tx_buf[0]&0x04))
			{
				/*显示框架*/	
				DisplayStructure();
				
				LCD_Display_Words(1,0,"请输入步数：");	
				LastStep=AT24Cxx_ReadTwoByte(16);	
				InputStep=LastStep;
				IntDisplay(LastStep,2,0);			
				while(!(tx_buf[0]&0x04))
				{
						if((tx_buf[1]&0x02))	
						{
//							LCD_Clear();								
							LCD_Display_Words(3,0,"正在复位....");					
							NRF_Service(525,RESET);						
							tx_buf[1]=tx_buf[1]&0xfd;		
							AT24Cxx_WriteTwoByte(16,0);	
							InputStep=0;
							LastStep=0;							
							IntDisplay(InputStep,2,0);	
							LCD_Display_Words(1,0,"请输入步数：");								
						}	
						if(tx_buf[0]&0x01)		//步数加1
						{
							InputStep++;
							if(InputStep > 480)
								InputStep = 0;
							IntDisplay(InputStep,2,0);
							delay_ms(40);	
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_8)!=0)		
								tx_buf[0]=tx_buf[0]&0xfe;									
						}

						if((tx_buf[0]&0x02))		//步数减1
						{
							InputStep--;
							if(InputStep <0)
								InputStep = 480;
							IntDisplay(InputStep,2,0);
							delay_ms(40);								
							if(GPIO_ReadInputDataBit(GPIOB,GPIO_Pin_9)!=0)									
							tx_buf[0]=tx_buf[0]&0xfd;	
						}	
						
						if(tx_buf[0]&0x08)		//确认进入
						{
							LCD_Display_Words(3,0,"正在运行");								
							NRF_Service(InputStep,NORMAL);	
													
							tx_buf[0]=tx_buf[0]&0xf7;	
							AT24Cxx_WriteTwoByte(16,InputStep);								
						}						
				}			
			}			

			break;
		}		
//		index=0;		
	}	
	if(tx_buf[0]&0x04)		//退出当前功能模块，回到菜单页
	{
		LCD_Clear();	
		MenuDisplayStructure();		
		tx_buf[0]=tx_buf[0]&0xfb;	
//		index=0;				
	}	
}
}


void swap(u16 *data1,u16 *data2)	
{
	u16 temp;
	temp=*data1;
	*data1=*data2;
	*data2=temp;		
}
void IntDisplay(u16 data,u8 row,u8 column)
{
		unsigned char c[4]={'0','0','0'};
		if(data>99)
		{
			c[0]=c[0]+data/100%10;
			c[1]=c[1]+data/10%10;
			c[2]=c[2]+data%10;
		}
		if((data>9)&&(data<100))
		{
			c[0]=c[0]+data/10%10;
			c[1]=c[1]+data%10;
			c[2]=' ';
		}		
		if(data<10)
		{
			c[0]=c[0]+data%10;
			c[1]=' ';
			c[2]=' ';
		}			
		LCD_Display_Words(row,column,c);
		delay_ms(10);	
}
void IntDisplay2(u16 data,u8 row,u8 column)
{
		unsigned char c2[5]={'0','0','0','0'};
		if(data>999)
		{
			c2[0]=c2[0]+data/1000%10;
			c2[1]=c2[1]+data/100%10;
			c2[2]=c2[2]+data/10%10;
			c2[3]=c2[3]+data%10;
		}
		if((data>99)&&(data<1000))
		{
			c2[0]=c2[0]+data/100%10;
			c2[1]=c2[1]+data/10%10;
			c2[2]=c2[2]+data%10;
			c2[3]=' ';
		}				
		if((data>9)&&(data<100))
		{
			c2[0]=c2[0]+data/10%10;
			c2[1]=c2[1]+data%10;
			c2[2]=' ';
			c2[3]=' ';			
		}		
		if(data<10)
		{
			c2[0]=c2[0]+data%10;
			c2[1]=' ';
			c2[2]=' ';
			c2[3]=' ';			
		}			
		LCD_Display_Words(row,column,c2);
		delay_ms(10);	
}

void IntDisplay3(u16 data,u8 row,u8 column)
{
		unsigned char c2[2]={'0'};
			c2[0]=c2[0]+data%10;;	
		LCD_Display_Words(row,column,c2);
		delay_ms(10);	
}

void IntDisplay4(int data,u8 row,u8 column)
{
	u8 sign=0;
	unsigned char c[5]={'0','0','0','0'};
	
	if(data<0)
	{
		data=0-data;		
		sign=1;
	}		
		if(data>99)
		{
			c[0]=' ';	
			c[1]=c[1]+data/100%10;
			c[2]=c[2]+data/10%10;
			c[3]=c[3]+data%10;
			if(sign==1)
				c[0]='-';
		}
		if((data>9)&&(data<100))
		{
			c[0]=' ';	
			c[1]=' ';	
			c[2]=c[2]+data/10%10;
			c[3]=c[3]+data%10;	
			if(sign==1)
				c[1]='-';			
		}		
		if(data<10)
		{
			c[0]=' ';
			c[1]=' ';
			c[2]=' ';
			c[3]=c[3]+data%10;
			if(sign==1)
				c[2]='-';
		}			
		LCD_Display_Words(row,column,c);
		delay_ms(10);	
}

void DisplayStructure()
{
		LCD_Display_Words(0,0,"NRF:");
		LCD_Display_Words(0,4,"CON:");			
}
void MenuDisplayStructure()
{
		LCD_Display_Words(0,0,"1 EXV");
		LCD_Display_Words(0,4,"2 SolVal");			
		LCD_Display_Words(1,0,"3 SerMt");
		LCD_Display_Words(1,4,"4 PWM");
		LCD_Display_Words(2,0,"5 ADC");
		LCD_Display_Words(2,4,"6 Other");
		LCD_Display_Words(3,0,"Select:");
	LCD_Display_Words(3,7," %");	
}
void Menu()
{

	
}
void ADC_Service()
{
	float press;
		u16 P1,T1;
		u8 temp,i=0;
		ADC_RegularChannelConfig(ADC1,ADC_Channel_0,1,ADC_SampleTime_239Cycles5);	//ADC0
		P1=ReadADC();			
		IntDisplay2(P1,0,5);		
		press=1.0173*P1-231.967;
		IntDisplay2((u16)press,1,3);
		press=0.295*P1-60.33;
		IntDisplay2((u16)press,2,3);
		ADC_RegularChannelConfig(ADC1,ADC_Channel_1,1,ADC_SampleTime_239Cycles5);	
		T1=ReadADC();	
		while(1){
			if(T1>Arr[0])
			{
				temp=0;
				break;
			}
			if(T1<=Arr[180])
			{
				temp=180;
				break;
			}
			if(T1<=Arr[i]&&T1>Arr[i+1])
			{
				temp=i;
				break;
			}
			else
				i++;
		}
		IntDisplay4((temp-40),3,2);
		IntDisplay2(T1,3,6);	
		
}

void ADC_Service_Duct()
{
		u16 T1;
		u8 temp,i=0;
		ADC_RegularChannelConfig(ADC1,ADC_Channel_1,1,ADC_SampleTime_239Cycles5);	
		T1=ReadADC();	
		while(1){
			if(T1>ArrDuct[0])
			{
				temp=0;
				break;
			}
			if(T1<=ArrDuct[140])
			{
				temp=140;
				break;
			}
			if(T1<=ArrDuct[i]&&T1>ArrDuct[i+1])
			{
				temp=i;
				break;
			}
			else
				i++;
		}
		IntDisplay4((temp-40),1,2);
		IntDisplay2(T1,3,2);		
}

void StepMotorCW(u16 step)
{
	if(step==0)
		return;
		while(1)
		{		
				GPIO_SetBits(GPIOA,in1);
				GPIO_ResetBits(GPIOA,in2|in3|in4);
				delay_ms(20);		
				step--;
				if(step==0)
					break;

				GPIO_SetBits(GPIOA,in1|in2);
				GPIO_ResetBits(GPIOA,in3|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;	
			
				GPIO_SetBits(GPIOA,in2);
				GPIO_ResetBits(GPIOA,in1|in3|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in2|in3);
				GPIO_ResetBits(GPIOA,in1|in4);
				delay_ms(20);		
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in3);
				GPIO_ResetBits(GPIOA,in1|in2|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in3|in4);
				GPIO_ResetBits(GPIOA,in1|in2);
				delay_ms(20);	
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in4);
				GPIO_ResetBits(GPIOA,in1|in2|in3);	
				delay_ms(20);			
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in1|in4);
				GPIO_ResetBits(GPIOA,in2|in3);	
				delay_ms(20);	
				step--;
				if(step==0)
					break;			
		}		
}

void StepMotorCCW(u16 step)
{
	if(step==0)
		return;
		while(1)
		{	
				GPIO_SetBits(GPIOA,in1);
				GPIO_ResetBits(GPIOA,in2|in3|in4);
				delay_ms(20);		
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in1|in4);
				GPIO_ResetBits(GPIOA,in2|in3);	
				delay_ms(20);	
				step--;
				if(step==0)
					break;	

				GPIO_SetBits(GPIOA,in4);
				GPIO_ResetBits(GPIOA,in1|in2|in3);	
				delay_ms(20);			
				step--;
				if(step==0)
					break;
				
				GPIO_SetBits(GPIOA,in3|in4);
				GPIO_ResetBits(GPIOA,in1|in2);
				delay_ms(20);	
				step--;
				if(step==0)
					break;

				GPIO_SetBits(GPIOA,in3);
				GPIO_ResetBits(GPIOA,in1|in2|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;

				GPIO_SetBits(GPIOA,in2|in3);
				GPIO_ResetBits(GPIOA,in1|in4);
				delay_ms(20);		
				step--;
				if(step==0)
					break;

				GPIO_SetBits(GPIOA,in2);
				GPIO_ResetBits(GPIOA,in1|in3|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;

				GPIO_SetBits(GPIOA,in1|in2);
				GPIO_ResetBits(GPIOA,in3|in4);
				delay_ms(20);	
				step--;
				if(step==0)
					break;						
		}		
}	

void ServoMotor(u16 inputAD)
{
	u16 currentAD;
	u16 targetAD;	
		ADC_RegularChannelConfig(ADC1,ADC_Channel_3,1,ADC_SampleTime_239Cycles5);	//ADC2
		currentAD=ReadADC()/4;
	
	while(((currentAD-inputAD)>=40)||((currentAD-inputAD)<=-40))
	{
		ADC_RegularChannelConfig(ADC1,ADC_Channel_3,1,ADC_SampleTime_239Cycles5);	//ADC2
		currentAD=ReadADC()/4;
		IntDisplay2(currentAD,2,4);	
/*		if((currentAD-inputAD<5)&&(currentAD-inputAD>-5))	
		{
			GPIO_ResetBits(GPIOB,DC1|DC2);			
			break;
		}*/
		if((currentAD<inputAD))	//顺时针
		{
			GPIO_ResetBits(GPIOB,DC1);							
			GPIO_SetBits(GPIOB,DC2);
			if((currentAD-inputAD<-35)&&(currentAD-inputAD>-45))	
			{
				GPIO_ResetBits(GPIOB,DC1|DC2);			
				break;
			}			
		}
		else									//逆时针
		{
			GPIO_ResetBits(GPIOB,DC2);							
			GPIO_SetBits(GPIOB,DC1);
			if((currentAD-inputAD<45)&&(currentAD-inputAD>35))		
			{
				GPIO_ResetBits(GPIOB,DC1|DC2);			
				break;
			}				
		}
	}
		delay_ms(300);
		ADC_RegularChannelConfig(ADC1,ADC_Channel_3,1,ADC_SampleTime_239Cycles5);	//ADC2
		currentAD=ReadADC()/4;	
		while(((currentAD-inputAD)<40)&&((currentAD-inputAD)>-40))	//顺时针
		{
			ADC_RegularChannelConfig(ADC1,ADC_Channel_3,1,ADC_SampleTime_239Cycles5);	//ADC2
			currentAD=ReadADC()/4;
			IntDisplay2(currentAD,2,4);	
			
			if((currentAD-inputAD<2)&&(currentAD-inputAD>-2))	
			{
				GPIO_ResetBits(GPIOB,DC1|DC2);			
				return;
			}	
			
			if((currentAD<inputAD))	//顺时针
			{
				GPIO_ResetBits(GPIOB,DC1);							
				GPIO_SetBits(GPIOB,DC2);
				delay_ms(10);	
				GPIO_ResetBits(GPIOB,DC1|DC2);	
				delay_ms(200);					
			}
			else									//逆时针
			{
				GPIO_ResetBits(GPIOB,DC2);							
				GPIO_SetBits(GPIOB,DC1);
				delay_ms(10);
				GPIO_ResetBits(GPIOB,DC1|DC2);			
				delay_ms(200);
				}				
			}
}

u8 LinearSearch(u16 *Array,u16 index,u8 length)
{
	int i=0;
	u8 result;
		while(1){
			if(index<Array[0])
			{
				index=0;
				break;
			}
			if(index>=Array[length-1])
			{
				result=100;
				break;
			}
			if(index>=Array[i]&&index<Array[i+1])
			{				
				result=(index-Array[i])*10/(Array[i+1]-Array[i])+i*10;
				break;
			}
			else
				i++;
		}		
			return result;	
}

void NRF_Service(u16 step,u8 direction)
{
		u8 i=0,num=0;	
		u8 mode=0;		
		u16 wdata;
		u8 Tx_Cnt=0,Rx_Cnt=0;
		u8 Tx_Flag=0,Rx_Flag=0;
		u8 TX_Mode_Flag,RX_Mode_Flag=0;
	
		l_auto=0;
		r_auto=0;
		save=0;

		tx_data[0]=step%255;
		tx_data[1]=step/255;
		tx_data[2]=direction;	

		while(NRF24L01_Check())  //检测NRF24L01是否存在
			{
				LCD_Display_Words(0,2,"NG");						
			}
				LCD_Display_Words(0,2,"OK");	

		while(RX_Mode_Flag==0)
		{		
				if(mode==0)
				{
					NRF24L01_TX_Mode();
					TX_Mode_Flag = NRF24L01_TxPacket(tx_data);
					if(TX_Mode_Flag==TX_OK)
					{
						LCD_Display_Words(0,6,"OK");
						mode=1; 
						Tx_Cnt=0;
						Tx_Flag=1;
					}
					Tx_Cnt++;
					if (Tx_Cnt==5)
					{
//						LCD_Display_Words(0,6,"NG");
						mode=1;
						Tx_Cnt=0;
					}
				}
				else
				{
					NRF24L01_RX_Mode(); 
					RX_Mode_Flag = NRF24L01_RxPacket(rx_data);
					if(RX_Mode_Flag==0 && RX_Mode_Flag == 0) //接收到数据显示
					{
						rx_data[8]='\0'; 	
						LCD_Display_Words(0,7,"OK");
						IntDisplay(rx_data[0]+rx_data[1]*255,2,4);					
						mode=0; 
						Rx_Cnt=0;
						Rx_Flag=1;
						RX_Mode_Flag = 1;
					}
					Rx_Cnt++;
					if (Rx_Cnt==5)
					{
//						LCD_Display_Words(0,7,"NG");
						mode=0;
						Rx_Cnt=0;
					}					
				}		
				delay_ms(2);	//不加延时会导致通讯失败
				i++;
}
}

